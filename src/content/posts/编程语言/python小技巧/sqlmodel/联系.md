---
title: è”ç³»
description: ""
image: ""
published: 2025-01-05
tags:
  - python
  - wev
  - æ•°æ®åº“
category: python
draft: false
---

# Join

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª team æ¨¡å‹

```python
from sqlmodel import Field, SQLModel, create_engine

class Team(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    headquarters: str

class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: int | None = Field(default=None, index=True)

    team_id: int | None = Field(default=None, foreign_key="team.id")
```

åœ¨ field ä¸­,æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¤–é”®.

å¯¹äºæŸ¥è¯¢,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¿è¡¨æŸ¥è¯¢

```python
def select_heroes():
    with Session(engine) as session:
        statement = select(Hero, Team).where(Hero.team_id == Team.id)
        for hero, team in results:
            print("Hero:", hero, "Team:", team)
```

å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ join,åœ¨ SQLModel (å®é™…ä¸Šæ˜¯ SQLAlchemy) ä¸­ï¼Œå½“ä½¿ç”¨Â `.join()`Â æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºæ¨¡å‹æ—¶å·²ç»å£°æ˜äº†Â `foreign_key`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ä¼ é€’Â `ON`Â éƒ¨åˆ†ï¼Œå®ƒæ˜¯è‡ªåŠ¨æ¨æ–­çš„ã€‚

```python
def select_heroes():
    with Session(engine) as session:
        statement = select(Hero, Team).join(Team).where(Team.name == "Preventers")
        results = session.exec(statement)
        for hero, team in results:
            print("Hero:", hero, "Team:", team)
```

# å…³ç³»å±æ€§

å‰é¢æˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•ä½¿ç”¨å…·æœ‰æŒ‡å‘å…¶ä»–åˆ—çš„å¤–é”®æ¥ç®¡ç†å…·æœ‰ç®¡ç†çš„è¡¨ä¸­çš„æ•°æ®åº“,ç°åœ¨æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨å…³ç³»å±æ€§ä»¥æ›´ç†Ÿæ‚‰çš„æ–¹å¼æ›´æ¥è¿‘ python çš„æ–¹å¼æ¥å¤„ç†æ•°æ®åº“ä¸­çš„æ•°æ®

## å£°æ˜å…³ç³»å±æ€§

å¯¼ç›®å‰ä¸ºæ­¢,æˆ‘ä»¬åªåœ¨ select æŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨ team_id æ¥é“¾æ¥è¡¨,ç°åœ¨æˆ‘ä»¬æ¥ä¸ºè¿™ç±»æ¨¡å‹ç±»æ·»åŠ  RelationShip å±æ€§

```python
from sqlmodel import Field, Relationship, Session, SQLModel, create_engine

class Team(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    headquarters: str

    heroes: list["Hero"] = Relationship(back_populates="team")

class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: int | None = Field(default=None, index=True)

    team_id: int | None = Field(default=None, foreign_key="team.id")
    team: Team | None = Relationship(back_populates="heroes")
```

ä¹Ÿè®¸ä½ ä¼šæ³¨æ„åˆ°è¿™é‡Œçš„ "Hero",åœ¨ä»£ç ä¸­çš„é‚£ä¸€è¡Œï¼ŒPython è§£é‡Šå™¨æ­¤æ—¶**ä¸çŸ¥é“ä»»ä½•åä¸ºÂ `Hero`Â çš„ç±»**ï¼Œå¦‚æœæˆ‘ä»¬å°†å®ƒç›´æ¥æ”¾åœ¨é‚£é‡Œï¼Œå®ƒä¼šå°è¯•æŸ¥æ‰¾ä½†å¤±è´¥ã€‚ğŸ˜­

ä½†æ˜¯é€šè¿‡å°†å®ƒæ”¾åœ¨å¼•å·ä¸­ï¼Œä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè§£é‡Šå™¨ä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«æ–‡æœ¬Â `"Hero"`ã€‚

ä½†æ˜¯ç¼–è¾‘å™¨å’Œå…¶ä»–å·¥å…·å¯ä»¥çœ‹åˆ°**è¯¥å­—ç¬¦ä¸²å®é™…ä¸Šæ˜¯ä¸€ä¸ªç±»å‹æ³¨è§£**ï¼Œå¹¶æä¾›æ‰€æœ‰çš„è‡ªåŠ¨å®Œæˆã€ç±»å‹æ£€æŸ¥ç­‰åŠŸèƒ½ã€‚ğŸ‰

## ä»€ä¹ˆæ˜¯è¿™äº›å…³ç³»å±æ€§

è¿™äº›æ–°å±æ€§ä¸å­—æ®µä¸åŒï¼Œå®ƒä»¬**ä¸ç›´æ¥è¡¨ç¤º**æ•°æ®åº“ä¸­çš„åˆ—ï¼Œå®ƒä»¬çš„å€¼ä¹Ÿä¸æ˜¯åƒæ•´æ•°è¿™æ ·çš„å•ä¸ªå€¼ã€‚å®ƒä»¬çš„å€¼æ˜¯ç›¸å…³çš„å®é™…**æ•´ä¸ªå¯¹è±¡**ã€‚

å› æ­¤ï¼Œåœ¨Â `Hero`Â å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨è°ƒç”¨Â `hero.team`ï¼Œæ‚¨å°†è·å¾—è¯¥è‹±é›„æ‰€å±çš„æ•´ä¸ªÂ `Team`Â å®ä¾‹å¯¹è±¡ã€‚âœ¨

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥ä¸€ä¸ªÂ `hero`Â æ˜¯å¦å±äºä»»ä½•Â `team`ï¼ˆå¦‚æœÂ `.team`Â ä¸æ˜¯Â `None`ï¼‰ï¼Œç„¶åæ‰“å°å›¢é˜Ÿçš„Â `name`

```python
def create_heroes():
    with Session(engine) as session:
        team_preventers = Team(name="Preventers", headquarters="Sharp Tower")
        team_z_force = Team(name="Z-Force", headquarters="Sister Margaret's Bar")

        hero_deadpond = Hero(
            name="Deadpond", secret_name="Dive Wilson", team=team_z_force
        )
        hero_rusty_man = Hero(
            name="Rusty-Man", secret_name="Tommy Sharp", age=48, team=team_preventers
        )
        hero_spider_boy = Hero(name="Spider-Boy", secret_name="Pedro Parqueador")
        session.add(hero_deadpond)
        session.add(hero_rusty_man)
        session.add(hero_spider_boy)
        session.commit()

        session.refresh(hero_deadpond)
        session.refresh(hero_rusty_man)
        session.refresh(hero_spider_boy)

        print("Created hero:", hero_deadpond)
        print("Created hero:", hero_rusty_man)
        print("Created hero:", hero_spider_boy)
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ relationship æ¥åˆ›å»ºç±»äº†,æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä½¿ç”¨ `session.add(team)`

# è¯»å–å…³ç³»

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹å¦‚ä½•è¯»å–å…³ç³»

```python
#æ—§æ–¹æ³•
def select_heroes():
    with Session(engine) as session:
        statement = select(Hero).where(Hero.name == "Spider-Boy")
        result = session.exec(statement)
        hero_spider_boy = result.one()

        statement = select(Team).where(Team.id == hero_spider_boy.team_id)
        result = session.exec(statement)
        team = result.first()
        print("Spider-Boy's team:", team)

# æ–°æ–¹æ³•
def select_heroes():
    with Session(engine) as session:
        statement = select(Hero).where(Hero.name == "Spider-Boy")
        result = session.exec(statement)
        hero_spider_boy = result.one()
        print("Spider-Boy's team again:", hero_spider_boy.team)
```

åŒæ ·,ç°åœ¨ç§»é™¤å…³ç³»å˜å¾—æ›´ç®€å•äº†

```python
def update_heroes():
    with Session(engine) as session:
        statement = select(Hero).where(Hero.name == "Spider-Boy")
        result = session.exec(statement)
        hero_spider_boy = result.one()

        hero_spider_boy.team = None
        session.add(hero_spider_boy)
        session.commit()

        session.refresh(hero_spider_boy)
```

# å…³ç³»åå‘å¡«å……

![image.png](https://picture-bed-1325530970.cos.ap-nanjing.myqcloud.com/20250105161711.png)

é‚£ä¹ˆ,æ¯ä¸ª RelationShip() ä¸­çš„ back_populates æ˜¯å•¥??è¯¥å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«**å¦ä¸€ä¸ª**æ¨¡å‹ç±»ä¸­çš„å±æ€§åç§°ã€‚å®ƒå‘Šè¯‰Â **SQLModel**ï¼Œå¦‚æœæ­¤æ¨¡å‹ä¸­å‘ç”Ÿäº†æ›´æ”¹ï¼Œå®ƒåº”è¯¥æ›´æ”¹å¦ä¸€ä¸ªæ¨¡å‹ä¸­çš„è¯¥å±æ€§ï¼Œå¹¶ä¸”å³ä½¿åœ¨ä¼šè¯æäº¤ä¹‹å‰ï¼ˆè¿™å°†å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼‰å®ƒä¹Ÿæœ‰æ•ˆ.å¡«å†™äº† back_populates å,æˆ‘ä»¬çš„ä»£ç å°±å¯ä»¥åœ¨ commit ä¹‹å‰æ›´æ–°äº†!

```python
class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: int | None = Field(default=None, index=True)

    team_id: int | None = Field(default=None, foreign_key="team.id")
    team: Team | None = Relationship(back_populates="heroes")

    weapon_id: int | None = Field(default=None, foreign_key="weapon.id")
    weapon: Weapon | None = Relationship(back_populates="hero")

    powers: list[Power] = Relationship(back_populates="hero")
```

æ³¨æ„è¿™é‡Œçš„ heroes å’Œ hero æ¥åŒºåˆ†å¤æ•° (æœ‰æ²¡æœ‰ç”¨æˆ‘ä¹Ÿä¸çŸ¥é“)

# å¤šå¯¹å¤š

ç°åœ¨å‡è®¾ä¸€ä¸ªè‹±é›„æœ‰å¤šä¸ªå›¢é˜Ÿ,ä¸€ä¸ªå›¢é˜Ÿä¹Ÿæœ‰å¤šä¸ªè‹±é›„

```python
class HeroTeamLink(SQLModel, table=True):
    team_id: int | None = Field(default=None, foreign_key="team.id", primary_key=True)
    hero_id: int | None = Field(default=None, foreign_key="hero.id", primary_key=True)

class Team(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    headquarters: str

    heroes: list["Hero"] = Relationship(back_populates="teams", link_model=HeroTeamLink)

class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: int | None = Field(default=None, index=True)

    teams: list[Team] = Relationship(back_populates="heroes", link_model=HeroTeamLink)
```

æˆ‘ä»¬ä½¿ç”¨Â **`back_populates="teams"`**ã€‚ä¹‹å‰æˆ‘ä»¬å¼•ç”¨äº†ä¸€ä¸ªå±æ€§Â `team`ï¼Œä½†ç°åœ¨æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»ºÂ `Hero`Â æ¨¡å‹æ—¶å°†å…¶é‡å‘½åä¸ºÂ `teams`ã€‚è¿™æ˜¯å…è®¸**å¤šå¯¹å¤š**å…³ç³»çš„é‡è¦éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨Â **`link_model=HeroTeamLink`**ã€‚å°±æ˜¯è¿™æ ·ã€‚âœ¨

## ä½¿ç”¨é¢å¤–å­—æ®µé“¾æ¥æ¨¡å‹

åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»æœªç›´æ¥ä¸Â `HeroTeamLink`Â æ¨¡å‹äº¤äº’ï¼Œå®ƒå…¨éƒ¨é€šè¿‡è‡ªåŠ¨çš„**å¤šå¯¹å¤š**å…³ç³»è¿›è¡Œã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æœ‰é¢å¤–çš„æ•°æ®æ¥æè¿°ä¸¤ä¸ªæ¨¡å‹ä¹‹é—´çš„é“¾æ¥å‘¢ï¼Ÿå‡è®¾æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªé¢å¤–çš„å­—æ®µ/åˆ—æ¥è¯´æ˜ä¸€ä¸ªè‹±é›„æ˜¯å¦ä»ç„¶åœ¨å›¢é˜Ÿä¸­**è®­ç»ƒ**ï¼Œæˆ–è€…ä»–ä»¬æ˜¯å¦å·²ç»åœ¨æ‰§è¡Œä»»åŠ¡ç­‰ç­‰ã€‚

## ä½¿ç”¨ä¸¤ä¸ªä¸€å¯¹å¤šå…³ç³»çš„é“¾æ¥æ¨¡å‹

å¤„ç†è¿™ç§æƒ…å†µçš„æ–¹æ³•æ˜¯æ˜¾å¼ä½¿ç”¨é“¾æ¥æ¨¡å‹ï¼Œä»¥ä¾¿èƒ½å¤Ÿè·å–å’Œä¿®æ”¹å…¶æ•°æ®ï¼ˆé™¤äº†æŒ‡å‘Â `Hero`Â å’ŒÂ `Team`Â çš„ä¸¤ä¸ªæ¨¡å‹çš„å¤–é”®ï¼‰ã€‚

```python
class HeroTeamLink(SQLModel, table=True):
    team_id: int | None = Field(default=None, foreign_key="team.id", primary_key=True)
    hero_id: int | None = Field(default=None, foreign_key="hero.id", primary_key=True)
    is_training: bool = False

    team: "Team" = Relationship(back_populates="hero_links")
    hero: "Hero" = Relationship(back_populates="team_links")

class Team(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    headquarters: str

    hero_links: list[HeroTeamLink] = Relationship(back_populates="team")

class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: int | None = Field(default=None, index=True)

    team_links: list[HeroTeamLink] = Relationship(back_populates="hero")
```

```python
def update_heroes():
    with Session(engine) as session:

# Code here omitted ğŸ‘ˆ

        for link in hero_spider_boy.team_links:
            if link.team.name == "Preventers":
                link.is_training = False

        session.add(hero_spider_boy)
        session.commit()

        for link in hero_spider_boy.team_links:
            print("Spider-Boy team:", link.team, "is training:", link.is_training)

# Code below omitted ğŸ‘‡
```

# å¤„ç†å¾ªç¯å¯¼å…¥

ä½†æ˜¯æˆ‘ä»¬æƒ³è¦å£°æ˜çš„è¿™äº›**ç±»å‹æ³¨è§£**åœ¨ _ è¿è¡Œæ—¶ _ æ˜¯ä¸éœ€è¦çš„ã€‚

å®é™…ä¸Šï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä½¿ç”¨äº† `List["Hero"]`ï¼Œå…¶ä¸­ `"Hero"` æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å—ï¼Ÿ

å¯¹äº Python æ¥è¯´ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œå®ƒ**ä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²**ã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨**å­—ç¬¦ä¸²ç‰ˆæœ¬**æ·»åŠ æˆ‘ä»¬éœ€è¦çš„ç±»å‹æ³¨è§£ï¼ŒPython å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç±»å‹æ³¨è§£ä¸­åªä½¿ç”¨å­—ç¬¦ä¸²ï¼Œè€Œä¸å¯¼å…¥ä»»ä½•ä¸œè¥¿ï¼Œç¼–è¾‘å™¨å°±ä¸çŸ¥é“æˆ‘ä»¬æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ— æ³•å¸®åŠ©æˆ‘ä»¬è¿›è¡Œ**è‡ªåŠ¨è¡¥å…¨**å’Œ**å†…è”é”™è¯¯**ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨Â `typing`Â æ¨¡å—ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æŠ€å·§ï¼Œä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å˜é‡Â `TYPE_CHECKING`ã€‚

å¯¹äºä½¿ç”¨ç±»å‹æ³¨è§£åˆ†æä»£ç çš„ç¼–è¾‘å™¨å’Œå·¥å…·ï¼Œå®ƒçš„å€¼ä¸ºÂ `True`ã€‚

ä½†æ˜¯å½“ Python æ‰§è¡Œæ—¶ï¼Œå®ƒçš„å€¼ä¸ºÂ `False`ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Â `if`Â ä»£ç å—ä¸­ä½¿ç”¨å®ƒï¼Œå¹¶åœ¨Â `if`Â ä»£ç å—å†…éƒ¨å¯¼å…¥å†…å®¹ã€‚å®ƒä»¬å°†åªä¸ºç¼–è¾‘å™¨â€œå¯¼å…¥â€ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶å¯¼å…¥ã€‚

```python
from typing import TYPE_CHECKING, Optional

from sqlmodel import Field, Relationship, SQLModel

if TYPE_CHECKING:
    from .team_model import Team

class Hero(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    secret_name: str
    age: Optional[int] = Field(default=None, index=True)

    team_id: Optional[int] = Field(default=None, foreign_key="team.id")
    team: Optional["Team"] = Relationship(back_populates="heroes")
```

è¯·è®°ä½ï¼Œç°åœ¨æˆ‘ä»¬ _ å¿…é¡» _ å°†Â `Team`Â çš„æ³¨è§£å†™æˆå­—ç¬¦ä¸²ï¼š`"Team"`ï¼Œè¿™æ · Python åœ¨è¿è¡Œæ—¶å°±ä¸ä¼šå‡ºç°é”™è¯¯ã€‚
